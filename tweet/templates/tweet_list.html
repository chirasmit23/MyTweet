{% extends "layout.html" %}
{% load humanize %}
{% block title %}Tweets{% endblock %}
{% block content %}
<div class="container py-4">
  <h2 class="text-center mb-4 text-white">Latest Tweets</h2>
  <div class="text-center mb-4">
    <a href="{% url 'tweet_create' %}" class="btn btn-primary">Create a Tweet</a>
  </div>
  <div class="row justify-content-center">
    <div class="col-md-8">
      {% for tweet in tweets %}
      <div class="card mb-4 shadow-sm" data-tweet-id="{{ tweet.id }}">
        {% if tweet.photo %}
          <img src="{{ tweet.photo.url }}" class="card-img-top" alt="Photo">
        {% endif %}
        <div class="card-body bg-body-secondary text-white">
          <div class="d-flex justify-content-between">
            <h5 class="mb-0">{{ tweet.user.username }}</h5>
            <small class="text-white" data-created="{{ tweet.created_at|date:'c' }}">
              {{ tweet.created_at|timesince }} ago
            </small>
          </div>
          <p class="fs-5 mt-2">{{ tweet.text }}</p>

          {% if request.user == tweet.user %}
          <div class="mb-2">
            <a href="{% url 'tweet_edit' tweet.id %}" class="btn btn-sm btn-outline-light">Edit</a>
            <form method="post" action="{% url 'tweet_delete' tweet.id %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
          </div>
          {% endif %}
          <div class="mt-3 d-flex align-items-center gap-3">
            <button class="btn btn-sm btn-outline-success like-btn" data-id="{{ tweet.id }}" data-url="{% url 'like_tweet' tweet.id %}">üëç</button>
            <span id="like-{{ tweet.id }}">{{ tweet.likes.count }}</span>
            <button class="btn btn-sm btn-outline-danger dislike-btn" data-id="{{ tweet.id }}" data-url="{% url 'dislike_tweet' tweet.id %}">üëé</button>
            <span id="dislike-{{ tweet.id }}">{{ tweet.dislikes.count }}</span>
          </div>
          <hr class="border-light">

          <button style="text-decoration: none;" class="btn btn-link p-0 text-white" data-bs-toggle="collapse" data-bs-target="#comments-card-{{ tweet.id }}">
            üí¨ View Comments ({{ tweet.comments.count }})
          </button>
          <div class="collapse mt-3" id="comments-card-{{ tweet.id }}">
            <div class="card card-body bg-body-secondary text-white">
              <div id="comments-{{ tweet.id }}">
                {% for comment in tweet.comments.all %}
                <div class="comment-row d-flex justify-content-between align-items-center mb-2" id="comment-{{ comment.id }}">
                  <div>
                    <b>{{ comment.user.username }}</b>: {{ comment.body }}<br>
                    <small class="text-muted" data-created="{{ comment.created_at|date:'c' }}">{{ comment.created_at|timesince }} ago</small>
                  </div>
                  {% if request.user == comment.user %}
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-light comment-edit"
                            data-id="{{ comment.id }}" data-url="{% url 'comment_edit' comment.id %}">Edit</button>
                    <button class="btn btn-sm btn-outline-danger comment-delete"
                            data-id="{{ comment.id }}" data-url="{% url 'comment_delete' comment.id %}">Delete</button>
                  </div>
                  {% endif %}
                </div>
                {% empty %}
                <p class="text-muted">No comments yet</p>
                {% endfor %}
              </div>
              <form class="comment-form d-flex mt-2" data-tweet-id="{{ tweet.id }}" data-url="{% url 'add_comment' tweet.id %}">
                {% csrf_token %}
                <input type="text" name="body" class="form-control me-2 bg-dark text-white" placeholder="Add a comment..." required>
                <button type="submit" class="btn btn-success">Post</button>
              </form>
            </div>
          </div>

        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% if not request.user.is_authenticated %}
<style>
.popup-box { 
  position: fixed; 
  top: 50%; 
  left: 50%; 
  transform: translate(-50%, -50%); /* centers the popup */
  z-index: 10800; 
}
.popup { 
  min-width: 240px; 
}
</style>
<div class="popup-box">
  <div id="popup" class="toast align-items-center text-bg-dark popup" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        You must <strong>log in</strong> or <strong>register</strong> to like, dislike, or comment.
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const popup = document.getElementById("popup");
    const showPopup = () => {
      new bootstrap.Toast(popup, { delay: 3000 }).show();
    };
    document.querySelectorAll(".like-btn, .dislike-btn").forEach(btn => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        showPopup();
      });
    });
    document.querySelectorAll(".comment-form").forEach(form => {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        showPopup();
      });
    });
  });
</script>
{% endif %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
function getCookie(name) {
  const pairs = document.cookie.split(';').map(s => s.trim());
  for (let p of pairs) {
    if (p.startsWith(name + '=')) return decodeURIComponent(p.split('=')[1]);
  }
  return null;
}
const csrftoken = getCookie('csrftoken');
async function post(url, body=null) {
  const options = { method: 'POST', headers: { 'X-CSRFToken': csrftoken } };
  if (body instanceof FormData) options.body = body;
  else if (body) {
    options.headers['Content-Type'] = 'application/x-www-form-urlencoded';
    options.body = new URLSearchParams(body).toString();
  }
  const res = await fetch(url, options);
  if (!res.ok) throw new Error('Request failed');
  return res.json();
}
function timeAgo(iso){
  if(!iso) return '';
  const sec = Math.floor((Date.now() - new Date(iso))/1000);
  if(sec<60) return 'just now';
  const m = Math.floor(sec/60);
  if(m<60) return m + ' minutes ago';
  const h = Math.floor(m/60);
  if(h<24) return h + ' hours ago';
  const d = Math.floor(h/24);
  return d + ' days ago';
}
function updateTimes(){
  document.querySelectorAll('[data-created]').forEach(el=>{
    el.textContent = timeAgo(el.getAttribute('data-created'));
  });
}
setInterval(updateTimes, 60_000);
updateTimes();
document.querySelectorAll('.like-btn').forEach(btn=>{
  btn.addEventListener('click', async function(){
    const url = this.dataset.url, id = this.dataset.id;
    try {
      const data = await post(url);
      document.getElementById('like-' + id).textContent = data.likes;
      if (data.dislikes !== undefined) document.getElementById('dislike-' + id).textContent = data.dislikes;
    } catch (e){ console.error(e); }
  });
});

document.querySelectorAll('.dislike-btn').forEach(btn=>{
  btn.addEventListener('click', async function(){
    const url = this.dataset.url, id = this.dataset.id;
    try {
      const data = await post(url);
      document.getElementById('dislike-' + id).textContent = data.dislikes;
      if (data.likes !== undefined) document.getElementById('like-' + id).textContent = data.likes;
    } catch (e){ console.error(e); }
  });
});
document.querySelectorAll('.comment-form').forEach(form=>{
  form.addEventListener('submit', async function(e){
    e.preventDefault();
    const url = this.dataset.url;
    const input = this.querySelector('input[name="body"]');
    const val = input.value.trim();
    if (!val) return;
    try {
      const fd = new FormData();
      fd.append('body', val);
      await post(url, fd);
      window.location.reload();
    } catch (e){ console.error(e); }
  });
});
function attachCommentButtons(commentEl){
  if (!commentEl) return;
  const editBtn = commentEl.querySelector('.comment-edit');
  const deleteBtn = commentEl.querySelector('.comment-delete');
  if (editBtn) {
    editBtn.addEventListener('click', async function(){
      const url = this.dataset.url;
      const newText = prompt('Edit comment', '');
      if (!newText) return;
      try {
        const data = await post(url, { body: newText });
        const div = commentEl.querySelector('div');
        div.innerHTML = `<b>@${esc(data.user)}</b>: ${esc(data.body)}<br>
                         <small class="text-muted" data-created="${data.created_at}">${timeAgo(data.created_at)}</small>`;
        const fd = new FormData();
      fd.append('body', val);
      await post(url, fd);
      window.location.reload();
      } catch (e){ console.error(e); }
    });
  }
  if (deleteBtn) {
   deleteBtn.addEventListener('click', async function(){
      if (!confirm('Delete comment?')) return;
      const url = this.dataset.url;
      try {
        const data = await post(url);
        if (data.deleted) commentEl.remove();
        const fd = new FormData();
      fd.append('body', val);
      await post(url, fd);
      window.location.reload();
      } catch (e){ console.error(e); }
    });
  }
}
document.querySelectorAll('.comment-row').forEach(el => attachCommentButtons(el));
</script>
{% endblock %}

